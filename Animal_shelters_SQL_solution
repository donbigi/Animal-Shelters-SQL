WITH temp_animals AS
	(
	SELECT animalid, sponsorid,
		animals.animaltype,
		birthdate, 
		weight,
		2021 - extract(year from (cast(birthdate as date))) AS age,
		animals.location,
		CASE WHEN animals.animaltype = 'Dog' AND weight <= 10 THEN 'DS'
			WHEN animals.animaltype = 'Dog' AND weight > 30 THEN 'DL'
			WHEN animals.animaltype = 'Dog' AND (weight > 10 OR weight <= 30) THEN 'DM'
			WHEN animals.animaltype = 'Cat' AND weight <= 5 THEN 'CS'
			WHEN animals.animaltype = 'Cat' AND weight > 7 THEN 'CL'
			WHEN animals.animaltype = 'Cat' AND (weight > 5 OR weight <= 7) THEN 'CM'
			WHEN animals.animaltype = 'Bird' AND weight <= 0.7 THEN 'BS'
			WHEN animals.animaltype = 'Bird' AND weight > 1.1 THEN 'BL'
			WHEN animals.animaltype = 'Bird' AND (weight > 0.7 OR weight <= 1.1) THEN 'DM'
		END AS sizeid
    FROM animals 
	LEFT JOIN sponsored_animals ON animals.animalid = sponsored_animals.sponsorid
	WHERE sponsorid IS NULL
	),
	temp2_animals AS 
	(
	SELECT temp_animals.animaltype,
	   size, 
	   SUM(size_costs.costs + location_costs.costs + age_costs.costs) as total 
	FROM temp_animals
		LEFT JOIN size_costs ON temp_animals.sizeid = size_costs.sizeid
	LEFT JOIN location_costs ON temp_animals.location = location_costs.location
	LEFT JOIN age_costs ON temp_animals.age = CAST(age_costs.age as int)
	GROUP BY temp_animals.animaltype, size
	)


SELECT animaltype,
	   size,
	   total,
       CAST((total * 100 / percentage_deno) AS DECIMAL(12,2)) AS percentage
FROM (SELECT animaltype,
			 size,
			 total,
			 CASE WHEN animaltype = 'Bird' THEN (select sum(total)from temp2_animals where animaltype = 'Bird')
				  WHEN animaltype = 'Cat' THEN (select sum(total)from temp2_animals where animaltype = 'Cat')
				  ELSE (select sum(total)from temp2_animals where animaltype = 'Dog')
			 END AS percentage_deno
		FROM temp2_animals
		GROUP BY animaltype, size, total) AS result
ORDER BY animaltype, size DESC